<div class="productos-admin-page">
  <div class="admin-header">
    <div class="container">
      <div class="header-content">
        <div class="header-title">
          <button class="btn-back" routerLink="/admin/gestion" title="Volver al Panel de Gesti√≥n">
            <span>‚Üê</span>
          </button>
          <h1>Gesti√≥n de Productos</h1>
        </div>
        <div class="header-actions">
          <button class="btn btn-primary" (click)="nuevo()">+ Nuevo Producto</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Filtros y B√∫squeda -->
    <div *ngIf="!mostrarFormulario" class="filters-bar">
      <div class="filters-grid">
        <!-- Fila 1: Categor√≠as -->
        <div class="filter-group">
          <label>Categor√≠a Principal:</label>
          <select [(ngModel)]="filtroCategoria" (change)="onFiltroCategoriaChange()">
            <option [value]="null">Todas</option>
            <option *ngFor="let cat of categoriasPadre" [value]="cat.id">{{ cat.nombre }}</option>
          </select>
        </div>

        <div class="filter-group" *ngIf="subcategoriasDisponibles.length > 0">
          <label>Subcategor√≠a:</label>
          <select [(ngModel)]="filtroSubcategoria" (change)="onFiltroSubcategoriaChange()">
            <option [value]="null">Todas</option>
            <option *ngFor="let subcat of subcategoriasDisponibles" [value]="subcat.id">{{ subcat.nombre }}</option>
          </select>
        </div>

        <div class="filter-group" *ngIf="subsubcategoriasDisponibles.length > 0">
          <label>Sub-subcategor√≠a:</label>
          <select [(ngModel)]="filtroSubsubcategoria" (change)="filtrarPorCategoria()">
            <option [value]="null">Todas</option>
            <option *ngFor="let subsubcat of subsubcategoriasDisponibles" [value]="subsubcat.id">{{ subsubcat.nombre }}
            </option>
          </select>
        </div>

        <div class="filter-group">
          <label>Estado de Stock:</label>
          <select [(ngModel)]="filtroEstadoStock" (change)="filtrarPorCategoria()">
            <option value="">Todos</option>
            <option value="disponible">Disponible</option>
            <option value="bajo">Bajo (‚â§ 5)</option>
            <option value="no_disponible">No disponible</option>
          </select>
        </div>
      </div>

      <!-- B√∫squeda -->
      <div class="search-group">
        <input type="text" placeholder="Buscar producto..." [(ngModel)]="filtroBusqueda"
          (keyup.enter)="buscarProductos()">
        <button class="btn-search" (click)="buscarProductos()">üîç Buscar</button>
        <button
          *ngIf="filtroCategoria || filtroSubcategoria || filtroSubsubcategoria || filtroEstadoStock || filtroBusqueda"
          class="btn-clear" (click)="limpiarFiltros()">‚úï Limpiar</button>
      </div>
    </div>

    <div *ngIf="loading" class="loading">
      <p>Cargando productos...</p>
    </div>

    <div *ngIf="!loading && productos.length === 0 && !mostrarFormulario" class="no-results">
      <div class="no-results-icon">üîç</div>
      <p>No hay resultados.</p>
    </div>

    <div *ngIf="mostrarFormulario" class="producto-form">
      <h2>{{ productoEditando ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
      <form (ngSubmit)="guardar()" enctype="multipart/form-data">
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" [(ngModel)]="nuevoProducto.nombre" name="nombre" required>
        </div>

        <div class="form-group">
          <label>Descripci√≥n</label>
          <textarea [(ngModel)]="nuevoProducto.descripcion" name="descripcion" rows="4"></textarea>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Precio Base *</label>
            <input type="number" [(ngModel)]="nuevoProducto.precio_base" name="precio_base" step="0.01" min="0"
              required>
          </div>

          <div class="form-group">
            <label>Precio con Descuento</label>
            <input type="number" [(ngModel)]="nuevoProducto.precio_descuento" name="precio_descuento" step="0.01"
              min="0">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Categor√≠a Principal * (Remeras o Shorts)</label>
            <select [(ngModel)]="categoriaPadreSeleccionada" name="categoria_padre" (change)="onCategoriaPadreChange()"
              required>
              <option [ngValue]="null">Seleccionar...</option>
              <option *ngFor="let cat of categoriasPadre" [ngValue]="cat.id">
                {{ cat.nombre }}
              </option>
            </select>
          </div>

          <!-- Nivel 2: Temporadas/Tipos (solo para Remeras) -->
          <div class="form-group" *ngIf="mostrarSubcategorias && subcategoriasNivel1.length > 0">
            <label>Tipo/Temporada *</label>
            <select [(ngModel)]="subcategoriaNivel1Seleccionada" name="subcategoria_nivel1"
              (change)="onSubcategoriaNivel1Change()" required>
              <option [ngValue]="null">Seleccionar...</option>
              <option *ngFor="let subcat of subcategoriasNivel1" [ngValue]="subcat.id">
                {{ subcat.nombre }}
              </option>
            </select>
          </div>

          <div class="form-group" *ngIf="subcategoriaNivel1Seleccionada && subcategoriasNivel2.length > 0">
            <label>Sub-Subcategor√≠a (ej: Liga) *</label>
            <select [(ngModel)]="nuevoProducto.categoria_id" name="categoria_id" required>
              <option [ngValue]="null">Seleccionar...</option>
              <option *ngFor="let liga of subcategoriasNivel2" [ngValue]="liga.id">
                {{ liga.nombre }}
              </option>
            </select>
          </div>

          <!-- Mensaje si no hay m√°s subcategor√≠as -->
          <div class="form-group" *ngIf="subcategoriaNivel1Seleccionada && subcategoriasNivel2.length === 0">
            <p style="font-size: 14px; color: #28a745; font-style: italic; margin-top: 5px;">
              ‚úì Categor√≠a lista para usar
            </p>
          </div>

          <div class="form-group">
            <label>Estado *</label>
            <select [(ngModel)]="nuevoProducto.activo" name="activo" required>
              <option [ngValue]="null">Seleccionar...</option>
              <option [ngValue]="true">Activo</option>
              <option [ngValue]="false">Inactivo</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Color</label>
            <app-color-picker [selectedColor]="colorSeleccionado" (colorSelected)="onColorSelected($event)">
            </app-color-picker>
            <input type="hidden" [(ngModel)]="nuevoProducto.color" name="color">
            <input type="hidden" [(ngModel)]="nuevoProducto.color_hex" name="color_hex">
          </div>

          <div class="form-group">
            <label>Versi√≥n</label>
            <select [(ngModel)]="nuevoProducto.version" name="version">
              <option value="">Seleccionar...</option>
              <option value="Hincha">Hincha</option>
              <option value="Jugador">Jugador</option>
            </select>
          </div>
        </div>


        <!-- Producto Relacionado con B√öSQUEDA ESCRITA -->
        <div class="form-group">
          <label>Producto Relacionado (mismo dise√±o, diferente color)</label>
          <div class="autocomplete-wrapper">
            <input type="text" placeholder="Escribe para buscar un producto..."
              [(ngModel)]="busquedaProductoRelacionado" (input)="buscarProductoRelacionado()" name="product_search"
              class="autocomplete-input" autocomplete="off">

            <!-- Bot√≥n limpiar -->
            <button *ngIf="nuevoProducto.producto_relacionado_id" type="button" class="btn-clear-autocomplete"
              (click)="limpiarProductoRelacionado()">
              ‚úï
            </button>

            <!-- Lista de sugerencias -->
            <div class="autocomplete-dropdown" *ngIf="productosRelacionadosFiltrados.length > 0">
              <div *ngFor="let prod of productosRelacionadosFiltrados" class="autocomplete-option"
                (click)="seleccionarProductoRelacionado(prod)">
                {{ prod.nombre }}
              </div>
            </div>
          </div>
          <small>Escribe para buscar un producto relacionado (variante de color/dise√±o)</small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nombre</label>
            <input type="text" [(ngModel)]="nuevoProducto.dorsal" name="dorsal" placeholder="Ej: Messi">
          </div>

          <div class="form-group">
            <label>N√∫mero</label>
            <input type="number" [(ngModel)]="nuevoProducto.numero" name="numero" min="0" placeholder="Ej: 10">
          </div>
        </div>

        <div class="form-group">
          <label>
            <input type="checkbox" [(ngModel)]="nuevoProducto.destacado" name="destacado">
            Producto destacado
          </label>
        </div>

        <!-- Im√°genes -->
        <div class="form-group">
          <label>Im√°genes del Producto</label>

          <!-- Im√°genes existentes (solo al editar) -->
          <div *ngIf="productoEditando && imagenesExistentes.length > 0" class="imagenes-existentes">
            <h4>Im√°genes Actuales:</h4>
            <div class="imagenes-grid">
              <div *ngFor="let img of imagenesExistentes" class="imagen-item">
                <img [src]="getFormattedImageUrl(img.url)" [alt]="nuevoProducto.nombre">
                <div class="imagen-badge" *ngIf="img.es_principal">Principal</div>
                <button type="button" class="btn-eliminar-imagen" (click)="eliminarImagenExistente(img.id)">‚úï</button>
              </div>
            </div>
          </div>

          <!-- Subir nuevas im√°genes -->
          <div class="imagenes-upload">
            <input type="file" id="imagenes-input" multiple accept="image/*" (change)="onFileSelected($event)"
              style="display: none;">
            <label for="imagenes-input" class="btn-upload">
              üì∑ Seleccionar Im√°genes
            </label>

            <!-- Preview de im√°genes seleccionadas -->
            <div *ngIf="imagenesPreview.length > 0" class="imagenes-preview">
              <h4>Nuevas Im√°genes:</h4>
              <div class="imagenes-grid">
                <div *ngFor="let preview of imagenesPreview; let i = index" class="imagen-item">
                  <img [src]="preview" [alt]="'Preview ' + (i + 1)">
                  <button type="button" class="btn-eliminar-imagen" (click)="eliminarImagenPreview(i)">‚úï</button>
                  <div class="imagen-badge" *ngIf="i === 0">Principal</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-primary">Guardar</button>
          <button type="button" class="btn btn-secondary" (click)="cancelar()">Cancelar</button>
        </div>
      </form>
    </div>

    <div *ngIf="!loading && !mostrarFormulario && productos.length > 0" class="productos-list">
      <div class="productos-table">
        <table>
          <thead>
            <tr>
              <th>Imagen</th>
              <th>Nombre</th>
              <th>Precio</th>
              <th>Categor√≠a</th>
              <th>Subcategor√≠a</th>
              <th>Versi√≥n</th>
              <th>Stock</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let producto of productos">
              <td>
                <img [src]="getImagenPrincipal(producto)" [alt]="producto.nombre" class="product-thumb">
              </td>
              <td class="col-nombre">{{ producto.nombre }}</td>
              <td>
                <div class="price-container">
                  <span *ngIf="producto.precio_descuento" class="price-discounted">
                    ${{ formatPrecio(producto.precio_descuento) }}
                  </span>
                  <span class="price">${{ formatPrecio(producto.precio_base) }}</span>
                </div>
              </td>
              <td>{{ producto.categoria_principal || producto.categoria_nombre }}</td>
              <td>{{ producto.subcategoria || '-' }}</td>
              <td>{{ producto.version || '-' }}</td>
              <td>
                <span *ngIf="producto.tiene_stock" class="stock-ok">Disponible</span>
                <span *ngIf="!producto.tiene_stock && producto.tiene_stock_bajo" class="stock-warning">Bajo</span>
                <span *ngIf="!producto.tiene_stock && !producto.tiene_stock_bajo" class="stock-out">Agotado</span>
              </td>
              <td>
                <span class="status-badge" [class.active]="producto.activo" [class.inactive]="!producto.activo">
                  {{ producto.activo ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
              <td>
                <div class="action-buttons">
                  <button class="btn-edit" (click)="editar(producto)" title="Editar">‚úèÔ∏è</button>
                  <button class="btn-delete" (click)="eliminar(producto)" title="Eliminar">üóëÔ∏è</button>
                  <button class="btn-stock" routerLink="/admin/stock" [queryParams]="{producto_id: producto.id}"
                    title="Gestionar Stock">üì¶</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginado -->
      <div class="pagination" *ngIf="totalPaginas > 1">
        <div class="pagination-info">
          <span>Mostrando {{ (paginaActual - 1) * productosPorPagina + 1 }} - {{ Math.min(paginaActual *
            productosPorPagina, totalProductos) }} de {{ totalProductos }} productos</span>
        </div>
        <div class="pagination-controls">
          <button class="btn-page" [disabled]="paginaActual === 1" (click)="anteriorPagina()">
            ‚Üê Anterior
          </button>

          <button class="btn-page" *ngFor="let pagina of getPaginasArray()" [class.active]="pagina === paginaActual"
            (click)="cambiarPagina(pagina)">
            {{ pagina }}
          </button>

          <button class="btn-page" [disabled]="paginaActual === totalPaginas" (click)="siguientePagina()">
            Siguiente ‚Üí
          </button>
        </div>
      </div>
    </div>
  </div>
</div>