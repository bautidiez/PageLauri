<div class="admin-container">
  <div class="admin-header">
    <h1>üéÅ Gesti√≥n de Promociones</h1>
    <div class="header-stats">
      <div class="stat-card success">
        <span class="stat-number">{{ stats.activas }}</span>
        <span class="stat-label">Activas</span>
      </div>
      <div class="stat-card info">
        <span class="stat-number">{{ stats.programadas }}</span>
        <span class="stat-label">Programadas</span>
      </div>
      <div class="stat-card muted">
        <span class="stat-number">{{ stats.expiradas }}</span>
        <span class="stat-label">Expiradas</span>
      </div>
    </div>
    <button class="btn btn-primary" (click)="nuevo()">
      ‚ûï Nueva Promoci√≥n
    </button>
  </div>

  <!-- FILTROS -->
  <div class="filters-bar">
    <input type="text" [(ngModel)]="busqueda" placeholder="üîç Buscar producto..." class="search-input">

    <div class="filter-tabs">
      <button class="tab" [class.active]="filtroEstado === 'todas'" (click)="filtroEstado = 'todas'">
        Todas
      </button>
      <button class="tab" [class.active]="filtroEstado === 'activas'" (click)="filtroEstado = 'activas'">
        Activas
      </button>
      <button class="tab" [class.active]="filtroEstado === 'programadas'" (click)="filtroEstado = 'programadas'">
        Programadas
      </button>
      <button class="tab" [class.active]="filtroEstado === 'expiradas'" (click)="filtroEstado = 'expiradas'">
        Expiradas
      </button>
    </div>
  </div>

  <!-- WIZARD -->
  <div *ngIf="mostrarWizard" class="modal-overlay" (click)="cancelar()">
    <div class="modal-wizard" (click)="$event.stopPropagation()">
      <div class="wizard-header">
        <h2>{{ modoEdicion ? 'Editar Promoci√≥n' : 'Nueva Promoci√≥n' }}</h2>
        <div class="steps">
          <div class="step" [class.active]="pasoActual === 1" [class.completed]="pasoActual > 1">
            <span class="step-number">1</span>
            <span>Alcance y Tipo</span>
          </div>
          <div class="step" [class.active]="pasoActual === 2">
            <span class="step-number">2</span>
            <span>Fechas y Resumen</span>
          </div>
        </div>
        <button class="btn-close" (click)="cancelar()">‚úï</button>
      </div>

      <div class="wizard-body">
        <!-- PASO 1: Producto y Tipo -->
        <div *ngIf="pasoActual === 1" class="wizard-content">
          <div class="form-group">
            <label>Alcance de la Promoci√≥n *</label>
            <div class="scope-selector">
              <button type="button" class="scope-btn" [class.active]="nuevaPromocion.alcance === 'producto'"
                (click)="nuevaPromocion.alcance = 'producto'">üì¶ Productos</button>
              <button type="button" class="scope-btn" [class.active]="nuevaPromocion.alcance === 'categoria'"
                (click)="nuevaPromocion.alcance = 'categoria'">üìÅ Categor√≠as</button>
              <button type="button" class="scope-btn" [class.active]="nuevaPromocion.alcance === 'tienda'"
                (click)="nuevaPromocion.alcance = 'tienda'">üè™ Toda la tienda</button>
            </div>
          </div>

          <!-- SELECTOR DE PRODUCTOS (Autocomplete) -->
          <div class="form-group" *ngIf="nuevaPromocion.alcance === 'producto'">
            <label>Seleccionar Producto(s) *</label>
            <div class="autocomplete-container">
              <input type="text" [(ngModel)]="searchQuery" (input)="onSearchInput()"
                placeholder="üîç Escribe para buscar productos..." class="form-control">
              <div class="autocomplete-results" *ngIf="searchResults.length > 0">
                <div *ngFor="let res of searchResults" (click)="selectProduct(res)" class="result-item">
                  {{ res.nombre }}
                </div>
              </div>
              <div class="autocomplete-results" *ngIf="searching">
                <div class="result-item">Buscando...</div>
              </div>
            </div>

            <div class="selected-items" *ngIf="productosSeleccionados.length > 0">
              <div *ngFor="let p of productosSeleccionados" class="selected-badge">
                {{ p.nombre }}
                <span class="remove" (click)="removeProduct(p.id)">‚úï</span>
              </div>
            </div>
          </div>

          <!-- SELECTOR DE CATEGOR√çAS (Multi-select) -->
          <div class="form-group" *ngIf="nuevaPromocion.alcance === 'categoria'">
            <label>Seleccionar Categor√≠a(s) *</label>
            <div class="category-grid">
              <div *ngFor="let cat of categorias" class="category-group">
                <div class="category-header" (click)="toggleCategoria(cat.id)"
                  [class.selected]="isCategoriaSelected(cat.id)">
                  <input type="checkbox" [checked]="isCategoriaSelected(cat.id)" readonly>
                  <strong>{{ cat.nombre }}</strong>
                </div>
                <!-- Subcategor√≠as -->
                <div class="subcategory-list" *ngIf="cat.subcategorias">
                  <div *ngFor="let sub of cat.subcategorias" class="subcategory-item" (click)="toggleCategoria(sub.id)"
                    [class.selected]="isCategoriaSelected(sub.id)">
                    <input type="checkbox" [checked]="isCategoriaSelected(sub.id)" readonly>
                    <span>{{ sub.nombre }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label>Tipo de Promoci√≥n *</label>
            <select [(ngModel)]="nuevaPromocion.tipo_promocion_id" class="form-control">
              <option [ngValue]="null">Seleccionar tipo...</option>
              <option *ngFor="let tipo of tiposPromocion" [ngValue]="tipo.id">
                {{ tipo.descripcion }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="nuevaPromocion.envio_gratis">
              üéÅ Env√≠o Gratis
            </label>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="nuevaPromocion.es_cupon">
              üéüÔ∏è Es un cup√≥n de descuento
            </label>
          </div>

          <div class="form-group" *ngIf="nuevaPromocion.es_cupon">
            <label>C√≥digo del Cup√≥n *</label>
            <input type="text" [(ngModel)]="nuevaPromocion.codigo" class="form-control" placeholder="Ej: VERANO2026"
              style="text-transform: uppercase;">
            <small class="help-text">El c√≥digo que el cliente deber√° ingresar.</small>
          </div>

          <div class="form-group" *ngIf="mostrarCampoValor()">
            <label>Valor *</label>
            <input type="number" [(ngModel)]="nuevaPromocion.valor" [placeholder]="getPlaceholderValor()"
              class=" form-control" min="0">
            <small class="help-text">{{ getPlaceholderValor() }}</small>
          </div>
        </div>

        <!-- PASO 2: Fechas -->
        <div *ngIf="pasoActual === 2" class="wizard-content">
          <div class="form-row">
            <div class="form-group">
              <label>Fecha de Inicio *</label>
              <input type="date" [(ngModel)]="nuevaPromocion.fecha_inicio" class="form-control">
            </div>
            <div class="form-group">
              <label>Fecha de Fin *</label>
              <input type="date" [(ngModel)]="nuevaPromocion.fecha_fin" class="form-control">
            </div>
          </div>

          <div class="form-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="nuevaPromocion.activa">
              Promoci√≥n activa
            </label>
          </div>

          <div class="resumen-promo">
            <h4>üìã Resumen</h4>
            <p><strong>Alcance:</strong> {{ getAlcanceResumen() }}</p>
            <p><strong>Tipo:</strong> {{ getTipoPromocionNombre(nuevaPromocion.tipo_promocion_id) }}</p>
            <p *ngIf="nuevaPromocion.envio_gratis"><strong>Beneficio:</strong> Env√≠o Gratis</p>
            <p *ngIf="nuevaPromocion.es_cupon"><strong>Cup√≥n:</strong> {{ nuevaPromocion.codigo }}</p>
            <p *ngIf="mostrarCampoValor()"><strong>Valor:</strong> {{ nuevaPromocion.valor }}</p>
            <p><strong>Periodo:</strong> {{ formatFecha(nuevaPromocion.fecha_inicio) }} - {{
              formatFecha(nuevaPromocion.fecha_fin) }}</p>
          </div>
        </div>
      </div>

      <div class="wizard-footer">
        <button class="btn btn-secondary" (click)="cancelar()">Cancelar</button>
        <div class="footer-right">
          <button class="btn btn-secondary" *ngIf="pasoActual > 1" (click)="pasoAnterior()">
            ‚Üê Anterior
          </button>
          <button class="btn btn-primary" *ngIf="pasoActual < totalPasos" (click)="siguientePaso()">
            Siguiente ‚Üí
          </button>
          <button class="btn btn-success" *ngIf="pasoActual === totalPasos" (click)="guardar()">
            üíæ Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- LOADING -->
  <div *ngIf="loading" class="loading">
    <p>Cargando promociones...</p>
  </div>

  <!-- EMPTY STATE -->
  <div *ngIf="!loading && promocionesFiltradas.length === 0" class="empty-state">
    <p>üì≠ No hay promociones que mostrar</p>
    <button class="btn btn-primary" (click)="nuevo()">Crear Primera Promoci√≥n</button>
  </div>

  <!-- LISTA DE PROMOCIONES -->
  <div *ngIf="!loading && promocionesFiltradas.length > 0" class="promociones-grid">
    <div *ngFor="let promo of promocionesFiltradas" class="promo-card" [class]="'promo-' + promo.estado">
      <div class="promo-header">
        <h3>
          <span *ngIf="promo.alcance === 'tienda'">üè™ Toda la tienda</span>
          <span *ngIf="promo.alcance === 'producto'">üì¶ {{ promo.productos_ids.length }} producto(s)</span>
          <span *ngIf="promo.alcance === 'categoria'">üìÅ {{ promo.categorias_ids.length }} categor√≠a(s)</span>
        </h3>
        <span class="badge" [ngClass]="getEstadoClass(promo.estado!)">
          {{ getEstadoLabel(promo.estado!) }}
        </span>
      </div>

      <div class="promo-body">
        <div class="promo-tipo">
          <strong>{{ getTipoPromocionNombre(promo.tipo_promocion_id) }}</strong>
          <span *ngIf="promo.envio_gratis" class="badge badge-success" style="margin-left: 5px;">Env√≠o Gratis</span>
        </div>
        <div class="promo-codigo" *ngIf="promo.es_cupon">
          <code>{{ promo.codigo }}</code>
        </div>
        <div class="promo-valor" *ngIf="promo.valor">
          <span class="valor-grande">{{ promo.valor }}</span>
          <span class="valor-unidad">{{ promo.tipo_nombre?.includes('porcentaje') ? '%' : '$' }} OFF</span>
        </div>
        <div class="promo-fechas">
          <div>
            <small>Inicio:</small>
            <strong>{{ formatFecha(promo.fecha_inicio) }}</strong>
          </div>
          <div>
            <small>Fin:</small>
            <strong>{{ formatFecha(promo.fecha_fin) }}</strong>
          </div>
        </div>
        <div class="promo-restante" *ngIf="promo.estado === 'activa'">
          <small>{{ getDiasRestantes(promo.fecha_fin) }} d√≠as restantes</small>
        </div>
      </div>

      <div class="promo-footer">
        <button class="btn-icon" (click)="editar(promo)" title="Editar">‚úèÔ∏è</button>
        <button class="btn-icon" (click)="eliminar(promo.id)" title="Eliminar">üóëÔ∏è</button>
      </div>
    </div>
  </div>
</div>