<div class="checkout-v2-container">
    <!-- Header Stepper -->
    <div class="stepper-header" *ngIf="currentStep < 4">
        <div class="step" [class.active]="currentStep >= 1">
            <div class="step-num">1</div>
            <span>Carrito</span>
        </div>
        <div class="step-line" [class.active]="currentStep >= 2"></div>
        <div class="step" [class.active]="currentStep >= 2">
            <div class="step-num">2</div>
            <span>Entrega</span>
        </div>
        <div class="step-line" [class.active]="currentStep >= 3"></div>
        <div class="step" [class.active]="currentStep >= 3">
            <div class="step-num">3</div>
            <span>Pago</span>
        </div>
    </div>

    <div class="checkout-content">
        <div class="main-form">
            <div [ngSwitch]="currentStep">

                <!-- STEP 1: RESUMEN CARRITO -->
                <div *ngSwitchCase="1" class="step-content">
                    <h2>Tus Productos</h2>
                    <div class="cart-items-list">
                        <div class="cart-item-card" *ngFor="let item of items">
                            <img [src]="getFormattedImageUrl(item.producto.imagenes[0]?.url)">
                            <div class="item-details">
                                <div class="item-info">
                                    <h4>{{ item.producto.nombre }}</h4>
                                    <p>Talle: {{ item.talle.nombre }} | Cant: {{ item.cantidad }}</p>

                                    <div class="checkout-item-price">
                                        <span [class.strikethrough]="item.descuento && item.descuento > 0">${{
                                            item.precio_unitario * item.cantidad | number:'1.0-0' }}</span>
                                        <span class="final" *ngIf="item.descuento && item.descuento > 0">
                                            ${{ (item.precio_unitario * item.cantidad) - item.descuento | number:'1.0-0'
                                            }}
                                        </span>
                                        <span class="badge" *ngIf="item.descuento && item.descuento > 0">OFF</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn-primary" (click)="nextStep()">Siguiente: Datos de Entrega</button>
                    </div>
                </div>

                <!-- STEP 2: DATOS + ENVIO (Merged) -->
                <div *ngSwitchCase="2" class="step-content" [formGroup]="datosForm">

                    <!-- 2.1 DATOS DE CONTACTO -->
                    <div class="section-block">
                        <h3 class="section-title">DATOS DE CONTACTO</h3>
                        <div class="field full">
                            <input type="email" formControlName="email" placeholder="Email"
                                [class.invalid]="datosForm.get('email')?.invalid && datosForm.get('email')?.touched">
                            <div class="error-msg"
                                *ngIf="datosForm.get('email')?.invalid && datosForm.get('email')?.touched">Este campo
                                deber√≠a estar completo</div>
                        </div>
                        <div class="field full">
                            <input type="text" formControlName="dni" placeholder="DNI / CUIT"
                                [class.invalid]="datosForm.get('dni')?.invalid && datosForm.get('dni')?.touched">
                            <div class="error-msg"
                                *ngIf="datosForm.get('dni')?.invalid && datosForm.get('dni')?.touched">Este campo es
                                requerido para la facturaci√≥n</div>
                        </div>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Quiero recibir ofertas y novedades por e-mail
                        </label>
                    </div>

                    <!-- 2.2 ENTREGA -->
                    <div class="section-block">
                        <h3 class="section-title">ENTREGA</h3>
                        <div class="zip-row">
                            <div class="field full">
                                <label>C√≥digo Postal</label>
                                <div class="input-with-action">
                                    <input type="text" formControlName="codigo_postal" placeholder="Ej: 5800"
                                        (keyup.enter)="calculateShipping()">
                                    <button type="button" class="btn-link" (click)="calculateShipping()"
                                        [disabled]="loading">
                                        {{ loading ? '...' : 'Calcular' }}
                                    </button>
                                </div>
                                <div class="shipping-loading-message" *ngIf="loading">
                                    <i class="fas fa-spinner fa-spin"></i> Calculando opciones de env√≠o...
                                </div>
                                <div class="error-msg"
                                    *ngIf="datosForm.get('codigo_postal')?.invalid && datosForm.get('codigo_postal')?.touched">
                                    Este campo es requerido</div>
                            </div>
                        </div>

                        <div class="loading-spinner" *ngIf="loading">Calculando opciones...</div>

                        <!-- Shipping Options Grouped -->
                        <div class="shipping-groups" *ngIf="shippingOptions.length > 0 && !loading"
                            [formGroup]="envioForm">

                            <!-- Domicilio -->
                            <div class="shipping-group" *ngIf="getOpcionesDomicilio().length > 0">
                                <h4 class="group-title">üì¶ Env√≠o a domicilio</h4>
                                <label class="shipping-option-item" *ngFor="let opt of getOpcionesDomicilio()"
                                    [class.selected]="envioForm.get('metodo_id')?.value === opt.id">
                                    <input type="radio" formControlName="metodo_id" [value]="opt.id">
                                    <div class="ship-info">
                                        <span class="ship-name">{{ opt.nombre }}</span>
                                        <span class="ship-time">{{ opt.tiempo_estimado }}</span>
                                    </div>
                                    <div class="ship-price">
                                        {{ opt.costo === 0 ? 'Gratis' : '$' + (opt.costo | number:'1.0-0') }}
                                    </div>
                                </label>
                            </div>

                            <!-- Retiro -->
                            <div class="shipping-group" *ngIf="getOpcionesRetiro().length > 0">
                                <h4 class="group-title">üè™ Retirar por</h4>
                                <label class="shipping-option-item" *ngFor="let opt of getOpcionesRetiro()"
                                    [class.selected]="envioForm.get('metodo_id')?.value === opt.id">
                                    <input type="radio" formControlName="metodo_id" [value]="opt.id">
                                    <div class="ship-info">
                                        <span class="ship-name">{{ opt.nombre }}</span>
                                        <span class="ship-time">{{ opt.tiempo_estimado }}</span>
                                    </div>
                                    <div class="ship-price">
                                        {{ opt.costo === 0 ? 'Gratis' : '$' + (opt.costo | number:'1.0-0') }}
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 2.3 DATOS DEL DESTINATARIO -->
                    <div class="section-block">
                        <h3 class="section-title">DATOS DEL DESTINATARIO</h3>
                        <div class="form-grid">
                            <div class="field">
                                <input type="text" formControlName="nombre" placeholder="Nombre"
                                    [class.invalid]="datosForm.get('nombre')?.invalid && datosForm.get('nombre')?.touched">
                                <div class="error-msg"
                                    *ngIf="datosForm.get('nombre')?.invalid && datosForm.get('nombre')?.touched">Este
                                    campo deber√≠a estar completo</div>
                            </div>
                            <div class="field">
                                <input type="text" formControlName="apellido" placeholder="Apellido"
                                    [class.invalid]="datosForm.get('apellido')?.invalid && datosForm.get('apellido')?.touched">
                                <div class="error-msg"
                                    *ngIf="datosForm.get('apellido')?.invalid && datosForm.get('apellido')?.touched">
                                    Este campo deber√≠a estar completo</div>
                            </div>
                            <div class="field full">
                                <input type="text" formControlName="telefono" placeholder="Tel√©fono"
                                    [class.invalid]="datosForm.get('telefono')?.invalid && datosForm.get('telefono')?.touched">
                                <div class="error-msg"
                                    *ngIf="datosForm.get('telefono')?.invalid && datosForm.get('telefono')?.touched">
                                    Este campo deber√≠a estar completo</div>
                            </div>
                            <!-- Address fields - Hidden if Retiro -->
                            <div class="form-grid" *ngIf="!isRetiro()">
                                <div class="field full">
                                    <input type="text" formControlName="calle" placeholder="Calle / Direcci√≥n"
                                        [class.invalid]="datosForm.get('calle')?.invalid && datosForm.get('calle')?.touched">
                                    <div class="error-msg"
                                        *ngIf="datosForm.get('calle')?.invalid && datosForm.get('calle')?.touched">Este
                                        campo deber√≠a estar completo</div>
                                </div>
                                <div class="field">
                                    <input type="text" formControlName="altura" placeholder="N√∫mero">
                                </div>
                                <div class="field">
                                    <input type="text" formControlName="piso" placeholder="Depto (Opcional)">
                                </div>
                                <div class="field full">
                                    <input type="text" formControlName="ciudad" placeholder="Ciudad / Localidad"
                                        [class.invalid]="datosForm.get('ciudad')?.invalid && datosForm.get('ciudad')?.touched">
                                </div>
                                <div class="field full">
                                    <select formControlName="provincia"
                                        [class.invalid]="datosForm.get('provincia')?.invalid && datosForm.get('provincia')?.touched">
                                        <option value="">Provincia...</option>
                                        <option value="Buenos Aires">Buenos Aires</option>
                                        <option value="CABA">CABA</option>
                                        <option value="Catamarca">Catamarca</option>
                                        <option value="Chaco">Chaco</option>
                                        <option value="Chubut">Chubut</option>
                                        <option value="C√≥rdoba">C√≥rdoba</option>
                                        <option value="Corrientes">Corrientes</option>
                                        <option value="Entre R√≠os">Entre R√≠os</option>
                                        <option value="Formosa">Formosa</option>
                                        <option value="Jujuy">Jujuy</option>
                                        <option value="La Pampa">La Pampa</option>
                                        <option value="La Rioja">La Rioja</option>
                                        <option value="Mendoza">Mendoza</option>
                                        <option value="Misiones">Misiones</option>
                                        <option value="Neuqu√©n">Neuqu√©n</option>
                                        <option value="R√≠o Negro">R√≠o Negro</option>
                                        <option value="Salta">Salta</option>
                                        <option value="San Juan">San Juan</option>
                                        <option value="San Luis">San Luis</option>
                                        <option value="Santa Cruz">Santa Cruz</option>
                                        <option value="Santa Fe">Santa Fe</option>
                                        <option value="Santiago del Estero">Santiago del Estero</option>
                                        <option value="Tierra del Fuego">Tierra del Fuego</option>
                                        <option value="Tucum√°n">Tucum√°n</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-block">
                        <h3 class="section-title">DATOS DE FACTURACI√ìN</h3>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Mis datos de facturaci√≥n y entrega son los mismos
                        </label>
                    </div>

                    <div class="actions">
                        <button class="btn-primary" (click)="nextStep()">CONTINUAR PARA EL PAGO</button>
                    </div>
                </div>

                <!-- STEP 3: PAGO -->
                <div *ngSwitchCase="3" class="step-content" [formGroup]="pagoForm">
                    <h3 class="section-title">MEDIO DE PAGO</h3>
                    <div class="payment-accordion">
                        <!-- Efectivo en el local (MOVED TO TOP) -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="radio-wrapper">
                                    <input type="radio" formControlName="metodo" value="efectivo_local">
                                    <span>Efectivo en el local</span>
                                </div>
                                <span class="badge">15% OFF</span>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('efectivo_local') |
                                    number:'1.2-2' }}</span>
                            </label>
                            <div class="payment-body" *ngIf="pagoForm.get('metodo')?.value === 'efectivo_local'">
                                <p>Pag√°s al retirar tu pedido en nuestro local. <strong>¬°Ten√©s un 15% de
                                        descuento!</strong></p>
                            </div>
                        </div>

                        <!-- Card -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="radio-wrapper">
                                    <input type="radio" formControlName="metodo" value="mercadopago_card">
                                    <span>Tarjeta de cr√©dito o d√©bito</span>
                                </div>
                                <span class="badge">Hasta 3 cuotas sin inter√©s</span>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('mercadopago_card') |
                                    number:'1.2-2' }}</span>
                            </label>
                            <div class="payment-body" *ngIf="pagoForm.get('metodo')?.value === 'mercadopago_card'">
                                <div class="form-grid">
                                    <div class="field full"><input type="text" placeholder="N√∫mero de tarjeta"></div>
                                    <div class="field full"><input type="text" placeholder="Nombre del titular"></div>
                                    <div class="field"><input type="text" placeholder="Vencimiento (MM/AA)"></div>
                                    <div class="field"><input type="text" placeholder="CVV"></div>
                                    <div class="field full">
                                        <select>
                                            <option>DNI</option>
                                        </select>
                                    </div>
                                    <div class="field full"><input type="text" placeholder="N√∫mero de documento"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Transferencia -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="radio-wrapper">
                                    <input type="radio" formControlName="metodo" value="transferencia">
                                    <span>Transferencia</span>
                                </div>
                                <span class="badge">15% OFF</span>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('transferencia') |
                                    number:'1.2-2' }}</span>
                            </label>
                            <div class="payment-body" *ngIf="pagoForm.get('metodo')?.value === 'transferencia'">
                                <p>Pag√°s ${{ getFinalTotal() | number:'1.2-2' }}. <strong>¬°Ten√©s un 15% de
                                        descuento!</strong>. Cuando termines la compra, vas a ver la informaci√≥n de
                                    pago.</p>
                            </div>
                        </div>

                        <!-- Efectivo (Rapipago) -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="radio-wrapper">
                                    <input type="radio" formControlName="metodo" value="efectivo">
                                    <span>Efectivo (Pago F√°cil / Rapipago)</span>
                                </div>
                                <span class="badge">15% OFF</span>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('efectivo') | number:'1.2-2'
                                    }}</span>
                            </label>
                            <div class="payment-body" *ngIf="pagoForm.get('metodo')?.value === 'efectivo'">
                                <p>Pag√°s ${{ getFinalTotal() | number:'1.2-2' }}. <strong>¬°Ten√©s un 15% de
                                        descuento!</strong></p>
                            </div>
                        </div>

                        <!-- MP -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="radio-wrapper">
                                    <input type="radio" formControlName="metodo" value="mercadopago">
                                    <span>Mercado Pago</span>
                                </div>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('mercadopago') |
                                    number:'1.2-2' }}</span>
                            </label>
                        </div>
                    </div>

                    <div class="actions">
                        <button class="btn-secondary" (click)="prevStep()">Volver</button>
                        <button class="btn-primary full-width" [disabled]="pagoForm.invalid || loading"
                            (click)="finalizarCompra()">
                            {{ loading ? 'Procesando...' : 'REALIZAR PEDIDO' }}
                        </button>
                    </div>
                </div>

                <!-- STEP 4: √âXITO -->
                <div *ngSwitchCase="4" class="success-screen centered-content">
                    <div class="success-icon">‚úÖ</div>
                    <h2>¬°Gracias por tu compra, {{ orderCreated?.cliente_nombre }}!</h2>
                    <p class="order-id">Tu pedido <strong>#{{ orderCreated?.numero_pedido }}</strong> ha sido
                        registrado.</p>

                    <div class="next-steps-container">

                        <!-- CASO 1: EFECTIVO EN EL LOCAL -->
                        <div *ngIf="orderCreated?.metodo_pago === 'efectivo_local'" class="payment-instructions">
                            <h3>Pasos a seguir:</h3>
                            <p>Para confirmar tu pedido, por favor envianos un mensaje por WhatsApp indicando que
                                abonar√°s en efectivo al retirar.</p>

                            <a [href]="getWhatsAppUrl(orderCreated)" target="_blank" class="btn-whatsapp">
                                <i class="fab fa-whatsapp"></i> Confirmar pedido por WhatsApp
                            </a>

                            <p class="note-sm">Si no nos contact√°s, nos comunicaremos con vos al tel√©fono o email
                                registrado para coordinar.</p>
                        </div>

                        <!-- CASO 2: TRANSFERENCIA -->
                        <div *ngIf="orderCreated?.metodo_pago === 'transferencia'" class="payment-instructions">
                            <h3>Datos para la transferencia:</h3>
                            <div class="bank-details-card">
                                <p><strong>Banco:</strong> Mercado Pago</p>
                                <p><strong>Titular:</strong> Tomas Cruseno</p>
                                <p><strong>CVU:</strong> 0000003100068933152485</p>
                                <p><strong>Alias:</strong> el.vestuario.r4</p>
                                <p><strong>Monto a transferir:</strong> ${{ orderCreated?.total | number:'1.0-2' }}</p>
                            </div>

                            <p class="important-msg">‚ö†Ô∏è IMPORTANTE: Envi√° el comprobante de transferencia por WhatsApp a
                                cualquiera de nuestros n√∫meros para confirmar tu pedido.</p>

                            <div class="whatsapp-buttons">
                                <a href="https://wa.me/5493564639908" target="_blank"
                                    class="btn-whatsapp-outline">Enviar a N√∫mero 1 (3564-639908)</a>
                                <a href="https://wa.me/5493564386992" target="_blank"
                                    class="btn-whatsapp-outline">Enviar a N√∫mero 2 (3564-386992)</a>
                            </div>
                        </div>

                        <!-- CASO 3: EFECTIVO (RAPIPAGO/PAGO FACIL) -->
                        <div *ngIf="orderCreated?.metodo_pago === 'efectivo'" class="payment-instructions">
                            <h3>Instrucciones de pago:</h3>
                            <p>Acercate a cualquier sucursal de Pago F√°cil o Rapipago e indic√° el siguiente CVU para
                                ingresar dinero:</p>

                            <div class="cvu-display">
                                0000003100068933152485
                            </div>

                            <p><strong>Monto a pagar:</strong> ${{ orderCreated?.total | number:'1.0-2' }}</p>

                            <p class="important-msg">‚ö†Ô∏è IMPORTANTE: Una vez realizado el pago, envi√° el comprobante por
                                WhatsApp.</p>

                            <a [href]="getWhatsAppUrl(orderCreated)" target="_blank" class="btn-whatsapp">
                                <i class="fab fa-whatsapp"></i> Enviar comprobante
                            </a>
                        </div>

                        <!-- CASO 4: TARJETA / MP (Check backend exact string, assumed 'mercadopago_card' or 'mercadopago') -->
                        <div *ngIf="orderCreated?.metodo_pago.includes('mercadopago')" class="payment-instructions">
                            <p>El pago se proces√≥ correctamente.</p>
                            <p>Por cualquier duda, pod√©s enviarnos el comprobante o consultarnos a nuestros n√∫meros:</p>
                            <div class="whatsapp-buttons">
                                <a href="https://wa.me/5493564639908" target="_blank"
                                    class="btn-whatsapp-outline">Contacto 1</a>
                                <a href="https://wa.me/5493564386992" target="_blank"
                                    class="btn-whatsapp-outline">Contacto 2</a>
                            </div>
                        </div>

                        <div class="final-actions">
                            <button class="btn-primary" routerLink="/productos">Seguir Comprando</button>
                            <button class="btn-secondary" routerLink="/mis-pedidos">Ver Mis Pedidos</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- SIDEBAR RESUMEN -->
        <div class="summary-sidebar" *ngIf="currentStep < 4">
            <div class="summary-card">
                <h3>Resumen del pedido</h3>
                <!-- Item simplified list in sidebar -->
                <div class="mini-items">
                    <div class="mini-item" *ngFor="let item of items">
                        <img [src]="getFormattedImageUrl(item.producto.imagenes[0]?.url)">
                        <div class="mini-details">
                            <span>{{ item.producto.nombre }} x {{ item.cantidad }}</span>
                            <strong>${{ (item.precio_unitario * item.cantidad) | number:'1.0-0' }}</strong>
                        </div>
                    </div>
                </div>

                <div class="summary-divider"></div>

                <div class="summary-row">
                    <span>Subtotal</span>
                    <span>${{ getSubtotalBruto() | number:'1.0-0' }}</span>
                </div>
                <div class="summary-row" *ngIf="getDescuentoProductos() > 0" style="color: #28a745;">
                    <span>Descuento Promociones</span>
                    <span>-${{ getDescuentoProductos() | number:'1.0-0' }}</span>
                </div>
                <!-- Line separator if product discount exists -->
                <div class="summary-divider" *ngIf="getDescuentoProductos() > 0"></div>

                <!-- Subtotal Net (What CartService.total returns) -->
                <div class="summary-row" *ngIf="getDescuentoProductos() > 0">
                    <span>Subtotal con desc.</span>
                    <span>${{ total | number:'1.0-0' }}</span>
                </div>

                <!-- Shipping Cost -->
                <div class="summary-row" *ngIf="getSelectedShipping()">
                    <span>Env√≠o ({{ getSelectedShipping().nombre }})</span>
                    <span>${{ getSelectedShipping().costo | number:'1.0-0' }}</span>
                </div>

                <!-- Payment Method Discount (15%) -->
                <div class="summary-row" *ngIf="getDiscountAmount() > 0">
                    <span>Descuento (15% OFF)</span>
                    <span class="discount-val">-${{ getDiscountAmount() | number:'1.0-0' }}</span>
                </div>

                <div class="summary-divider"></div>

                <!-- Total Highlight with Discount -->
                <div class="summary-row promo-highlight" *ngIf="getDiscountAmount() > 0">
                    <span class="promo-title">Total con 15% OFF:</span>
                    <span class="promo-value">${{ getFinalTotal() | number:'1.2-2' }}</span>
                </div>

                <!-- Standard Total Row (Struckthrough if discounted) -->
                <div class="summary-row total" [class.strikethrough]="getDiscountAmount() > 0" *ngIf="!loading">
                    <span>{{ getDiscountAmount() > 0 ? 'Total sin desc.' : 'Total' }}</span>
                    <span>${{ (total + (getSelectedShipping()?.costo || 0)) | number:'1.2-2' }}</span>
                </div>

                <!-- Loading Indicator -->
                <div class="summary-row total" *ngIf="loading">
                    <span>Total</span>
                    <span>Calculando...</span>
                </div>

                <!-- Payment Promo Badge -->
                <div class="payment-method-promo" *ngIf="getDiscountAmount() > 0">
                    ‚úì Descuento por pago con {{ pagoForm.get('metodo')?.value === 'transferencia' ? 'Transferencia' :
                    'Efectivo' }} aplicado
                </div>

                <!-- Coupon Section -->
                <div class="coupon-section" [formGroup]="couponForm">
                    <div class="coupon-input-group">
                        <input type="text" formControlName="code" placeholder="C√≥digo de cup√≥n">
                        <button class="btn-coupon" (click)="validateCoupon()"
                            [disabled]="couponForm.invalid || validatingCoupon">
                            {{ validatingCoupon ? '...' : 'Aplicar' }}
                        </button>
                    </div>
                    <p class="error-msg" *ngIf="couponError">{{ couponError }}</p>
                    <p class="success-msg" *ngIf="couponSuccess">{{ couponSuccess }}</p>

                    <div class="applied-coupon" *ngIf="appliedCoupon">
                        <div class="coupon-info">
                            <strong>üè∑Ô∏è {{ appliedCoupon.codigo }}</strong>
                            <span *ngIf="appliedCoupon.envio_gratis">Env√≠o Gratis</span>
                            <span
                                *ngIf="!appliedCoupon.envio_gratis && appliedCoupon.tipo_promocion_nombre === 'descuento_porcentaje'">
                                {{ appliedCoupon.valor }}% OFF
                            </span>
                            <span
                                *ngIf="!appliedCoupon.envio_gratis && appliedCoupon.tipo_promocion_nombre === 'descuento_fijo'">
                                ${{ appliedCoupon.valor }} OFF
                            </span>
                        </div>
                        <button class="remove-coupon" (click)="appliedCoupon = null; couponSuccess = ''">‚úï</button>
                    </div>
                    <!-- Version Marker -->
                    <div class="version-marker"
                        style="font-size: 10px; color: #ccc; text-align: right; margin-top: 15px;">
                        v1.0.6 - 15% Discount Active
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>