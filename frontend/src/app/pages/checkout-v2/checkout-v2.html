<div class="checkout-v2-container" [class.success-mode]="currentStep === 4">
    <!-- Header Stepper -->
    <div class="stepper-header" *ngIf="currentStep < 4">
        <div class="step" [class.active]="currentStep >= 1">
            <div class="step-num">1</div>
            <span>Carrito</span>
        </div>
        <div class="step-line" [class.active]="currentStep >= 2"></div>
        <div class="step" [class.active]="currentStep >= 2">
            <div class="step-num">2</div>
            <span>Entrega</span>
        </div>
        <div class="step-line" [class.active]="currentStep >= 3"></div>
        <div class="step" [class.active]="currentStep >= 3">
            <div class="step-num">3</div>
            <span>Pago</span>
        </div>
    </div>

    <div class="checkout-content" [class.success-layout]="currentStep === 4">
        <div class="main-form">
            <div [ngSwitch]="currentStep">

                <!-- STEP 1: RESUMEN CARRITO -->
                <div *ngSwitchCase="1" class="step-content">
                    <h2>Tus Productos</h2>
                    <div class="cart-items-list">
                        <div class="cart-item-card" *ngFor="let item of items">
                            <img [src]="getFormattedImageUrl(item.producto.imagenes[0]?.url)">
                            <div class="item-details">
                                <div class="item-info">
                                    <h4>{{ item.producto.nombre }}</h4>
                                    <p>Talle: {{ item.talle.nombre }} | Cant: {{ item.cantidad }}</p>

                                    <div class="checkout-item-price">
                                        <span [class.strikethrough]="item.descuento && item.descuento > 0">${{
                                            item.precio_unitario * item.cantidad | number:'1.0-0' }}</span>
                                        <span class="final" *ngIf="item.descuento && item.descuento > 0">
                                            ${{ (item.precio_unitario * item.cantidad) - item.descuento | number:'1.0-0'
                                            }}
                                        </span>
                                        <span class="badge" *ngIf="item.descuento && item.descuento > 0">OFF</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn-primary" (click)="nextStep()">Siguiente: Datos de Entrega</button>
                    </div>
                </div>

                <!-- STEP 2: DATOS + ENVIO (Merged) -->
                <div *ngSwitchCase="2" class="step-content" [formGroup]="datosForm">

                    <!-- 2.1 DATOS DE CONTACTO -->
                    <div class="section-block">
                        <h3 class="section-title">DATOS DE CONTACTO</h3>
                        <div class="field full">
                            <input type="email" formControlName="email" placeholder="Email"
                                [class.invalid]="datosForm.get('email')?.invalid && datosForm.get('email')?.touched">
                            <div class="error-msg"
                                *ngIf="datosForm.get('email')?.invalid && datosForm.get('email')?.touched">Este campo
                                deber√≠a estar completo</div>
                        </div>
                        <div class="field full">
                            <input type="text" formControlName="dni" placeholder="DNI / CUIT"
                                [class.invalid]="datosForm.get('dni')?.invalid && datosForm.get('dni')?.touched">
                            <div class="error-msg"
                                *ngIf="datosForm.get('dni')?.invalid && datosForm.get('dni')?.touched">Este campo es
                                requerido para la facturaci√≥n</div>
                        </div>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Quiero recibir ofertas y novedades por e-mail
                        </label>
                    </div>

                    <!-- 2.2 ENTREGA -->
                    <div class="section-block">
                        <h3 class="section-title">ENTREGA</h3>
                        <div class="zip-row">
                            <div class="field full">
                                <label>C√≥digo Postal</label>
                                <div class="input-with-action">
                                    <input type="text" formControlName="codigo_postal"
                                        placeholder="Ingres√° tu c√≥digo postal" (keyup.enter)="calculateShipping()">
                                    <button type="button" class="btn-link" (click)="calculateShipping()"
                                        [disabled]="loading">
                                        {{ loading ? '...' : 'Calcular' }}
                                    </button>
                                </div>
                                <a href="https://www.correoargentino.com.ar/formularios/cpa" target="_blank"
                                    class="cp-help-link">No s√© mi c√≥digo postal</a>
                                <div class="shipping-loading-message" *ngIf="loading">
                                    <i class="fas fa-spinner fa-spin"></i> Calculando opciones de env√≠o...
                                </div>
                                <div class="error-msg"
                                    *ngIf="datosForm.get('codigo_postal')?.hasError('required') && datosForm.get('codigo_postal')?.touched">
                                    Este campo es requerido</div>
                                <div class="error-msg"
                                    *ngIf="datosForm.get('codigo_postal')?.hasError('pattern') && datosForm.get('codigo_postal')?.touched">
                                    Solo se permiten n√∫meros</div>
                            </div>
                        </div>

                        <div class="loading-spinner" *ngIf="loading">Calculando opciones...</div>

                        <!-- Shipping Options Grouped -->
                        <div class="shipping-groups" *ngIf="shippingOptions.length > 0 && !loading"
                            [formGroup]="envioForm">

                            <!-- Domicilio -->
                            <div class="shipping-group" *ngIf="getOpcionesDomicilio().length > 0">
                                <h4 class="group-title">üì¶ Env√≠o a domicilio</h4>
                                <label class="shipping-option-item" *ngFor="let opt of getOpcionesDomicilio()"
                                    [class.selected]="envioForm.get('metodo_id')?.value === opt.id">
                                    <input type="radio" formControlName="metodo_id" [value]="opt.id">
                                    <div class="ship-info">
                                        <span class="ship-name">{{ opt.nombre }}</span>
                                        <span class="ship-time">{{ opt.tiempo_estimado }}</span>
                                    </div>
                                    <div class="ship-price">
                                        <ng-container *ngIf="opt.descuento">
                                            <span
                                                style="text-decoration: line-through; color: #94a3b8; margin-right: 5px;">${{
                                                opt.costo | number:'1.0-0' }}</span>
                                            <span style="color: #10b981; font-weight: bold;">Gratis</span>
                                        </ng-container>
                                        <ng-container *ngIf="!opt.descuento">
                                            {{ opt.costo === 0 ? 'Gratis' : '$' + (opt.costo | number:'1.0-0') }}
                                        </ng-container>
                                    </div>
                                </label>
                            </div>

                            <!-- Retiro -->
                            <div class="shipping-group" *ngIf="getOpcionesRetiro().length > 0">
                                <h4 class="group-title">üè™ Retirar por</h4>
                                <label class="shipping-option-item" *ngFor="let opt of getOpcionesRetiro()"
                                    [class.selected]="envioForm.get('metodo_id')?.value === opt.id">
                                    <input type="radio" formControlName="metodo_id" [value]="opt.id">
                                    <div class="ship-info">
                                        <span class="ship-name">{{ opt.nombre }}</span>
                                        <span class="ship-time">{{ opt.tiempo_estimado }}</span>
                                    </div>
                                    <div class="ship-price">
                                        <ng-container *ngIf="opt.descuento">
                                            <span
                                                style="text-decoration: line-through; color: #94a3b8; margin-right: 5px;">${{
                                                opt.costo | number:'1.0-0' }}</span>
                                            <span style="color: #10b981; font-weight: bold;">Gratis</span>
                                        </ng-container>
                                        <ng-container *ngIf="!opt.descuento">
                                            {{ opt.costo === 0 ? 'Gratis' : '$' + (opt.costo | number:'1.0-0') }}
                                        </ng-container>
                                    </div>
                                </label>
                            </div>

                            <!-- Branch Info Section (Only if Sucursal is selected) -->
                            <!-- Force Update 1 -->
                            <div class="branch-info-section" *ngIf="isSucursalSelected()"
                                style="margin-top: 15px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                                <div class="branch-links" style="margin-bottom: 10px; font-size: 14px;">
                                    <p style="margin-bottom: 5px;"><strong>üìç Busc√° tu sucursal m√°s cercana:</strong>
                                    </p>

                                    <div *ngIf="isAndreaniSelected()" style="margin-bottom: 5px;">
                                        <a href="https://www.andreani.com/buscar-sucursal" target="_blank"
                                            style="color: #2563eb; text-decoration: underline;">
                                            Ver sucursales Andreani <i class="fas fa-external-link-alt"
                                                style="font-size: 12px;"></i>
                                        </a>
                                    </div>

                                    <div *ngIf="isCorreoArgentinoSelected()">
                                        <a href="https://www.correoargentino.com.ar/formularios/sucursales"
                                            target="_blank" style="color: #2563eb; text-decoration: underline;">
                                            Ver sucursales Correo Argentino <i class="fas fa-external-link-alt"
                                                style="font-size: 12px;"></i>
                                        </a>
                                    </div>
                                </div>

                                <div class="field full">
                                    <label
                                        style="display: block; font-size: 13px; font-weight: 600; margin-bottom: 5px; color: #475569;">
                                        ¬øA qu√© sucursal te lo enviamos? <span style="color: red;">*</span>
                                    </label>
                                    <input type="text" formControlName="sucursal_info"
                                        placeholder="Ej: Andreani Centro - Calle San Mart√≠n 123"
                                        style="width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px;">
                                    <div class="hint" style="font-size: 12px; color: #64748b; margin-top: 4px;">
                                        Copi√° y peg√° el nombre y direcci√≥n de la sucursal aqu√≠.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 2.3 DATOS DEL DESTINATARIO -->
                    <div class="section-block">
                        <h3 class="section-title">DATOS DEL DESTINATARIO</h3>
                        <div class="form-grid">
                            <div class="field">
                                <input type="text" formControlName="nombre" placeholder="Nombre"
                                    [class.invalid]="datosForm.get('nombre')?.invalid && datosForm.get('nombre')?.touched">
                                <div class="error-msg"
                                    *ngIf="datosForm.get('nombre')?.invalid && datosForm.get('nombre')?.touched">Este
                                    campo deber√≠a estar completo</div>
                            </div>
                            <div class="field">
                                <input type="text" formControlName="apellido" placeholder="Apellido"
                                    [class.invalid]="datosForm.get('apellido')?.invalid && datosForm.get('apellido')?.touched">
                                <div class="error-msg"
                                    *ngIf="datosForm.get('apellido')?.invalid && datosForm.get('apellido')?.touched">
                                    Este campo deber√≠a estar completo</div>
                            </div>
                            <div class="field full">
                                <input type="text" formControlName="telefono" placeholder="Tel√©fono"
                                    [class.invalid]="datosForm.get('telefono')?.invalid && datosForm.get('telefono')?.touched">
                                <div class="error-msg"
                                    *ngIf="datosForm.get('telefono')?.invalid && datosForm.get('telefono')?.touched">
                                    Este campo deber√≠a estar completo</div>
                            </div>
                            <!-- Address fields - Hidden if Retiro -->
                            <div class="form-grid" *ngIf="!isRetiro()">
                                <div class="field full">
                                    <input type="text" formControlName="calle" placeholder="Calle / Direcci√≥n"
                                        [class.invalid]="datosForm.get('calle')?.invalid && datosForm.get('calle')?.touched">
                                    <div class="error-msg"
                                        *ngIf="datosForm.get('calle')?.invalid && datosForm.get('calle')?.touched">Este
                                        campo deber√≠a estar completo</div>
                                </div>
                                <div class="field">
                                    <input type="text" formControlName="altura" placeholder="N√∫mero">
                                </div>
                                <div class="field">
                                    <input type="text" formControlName="piso" placeholder="Piso">
                                </div>
                                <div class="field">
                                    <input type="text" formControlName="depto" placeholder="Depto">
                                </div>
                                <div class="field full">
                                    <input type="text" formControlName="ciudad" placeholder="Ciudad / Localidad"
                                        [class.invalid]="datosForm.get('ciudad')?.invalid && datosForm.get('ciudad')?.touched">
                                </div>
                                <div class="field full">
                                    <select formControlName="provincia"
                                        [class.invalid]="datosForm.get('provincia')?.invalid && datosForm.get('provincia')?.touched">
                                        <option value="">Provincia...</option>
                                        <option value="Buenos Aires">Buenos Aires</option>
                                        <option value="CABA">CABA</option>
                                        <option value="Catamarca">Catamarca</option>
                                        <option value="Chaco">Chaco</option>
                                        <option value="Chubut">Chubut</option>
                                        <option value="C√≥rdoba">C√≥rdoba</option>
                                        <option value="Corrientes">Corrientes</option>
                                        <option value="Entre R√≠os">Entre R√≠os</option>
                                        <option value="Formosa">Formosa</option>
                                        <option value="Jujuy">Jujuy</option>
                                        <option value="La Pampa">La Pampa</option>
                                        <option value="La Rioja">La Rioja</option>
                                        <option value="Mendoza">Mendoza</option>
                                        <option value="Misiones">Misiones</option>
                                        <option value="Neuqu√©n">Neuqu√©n</option>
                                        <option value="R√≠o Negro">R√≠o Negro</option>
                                        <option value="Salta">Salta</option>
                                        <option value="San Juan">San Juan</option>
                                        <option value="San Luis">San Luis</option>
                                        <option value="Santa Cruz">Santa Cruz</option>
                                        <option value="Santa Fe">Santa Fe</option>
                                        <option value="Santiago del Estero">Santiago del Estero</option>
                                        <option value="Tierra del Fuego">Tierra del Fuego</option>
                                        <option value="Tucum√°n">Tucum√°n</option>
                                    </select>
                                </div>
                                <div class="field full">
                                    <input type="text" formControlName="observaciones"
                                        placeholder="Observaciones (Ej: Entre que calles, color de port√≥n, etc)">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-block">
                        <h3 class="section-title">DATOS DE FACTURACI√ìN</h3>
                        <label class="checkbox-label">
                            <input type="checkbox" checked> Mis datos de facturaci√≥n y entrega son los mismos
                        </label>
                    </div>

                    <div class="actions">
                        <button class="btn-primary" (click)="nextStep()">CONTINUAR PARA EL PAGO</button>
                    </div>
                </div>

                <!-- STEP 3: PAGO -->
                <div *ngSwitchCase="3" class="step-content" [formGroup]="pagoForm">
                    <h3 class="section-title">MEDIO DE PAGO</h3>
                    <div class="payment-accordion">

                        <!-- Efectivo en el local -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="payment-radio-group">
                                    <input type="radio" formControlName="metodo" value="efectivo_local"
                                        (change)="updateDiscount()">
                                    <span class="payment-name">Efectivo en el local</span>
                                    <span class="badge" *ngIf="true">Hasta 15% OFF</span>
                                </div>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('efectivo_local') |
                                    number:'1.2-2' }}</span>
                            </label>
                            <div class="payment-body" *ngIf="pagoForm.get('metodo')?.value === 'efectivo_local'">
                                <p>Pag√°s al retirar tu pedido en nuestro local. <strong>¬°Ten√©s descuento por pago en
                                        efectivo!</strong> (10% en Shorts, 15% en el resto)</p>
                            </div>
                        </div>

                        <!-- Card -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="payment-radio-group">
                                    <input type="radio" formControlName="metodo" value="mercadopago_card"
                                        (change)="updateDiscount()">
                                    <span class="payment-name">Tarjeta de cr√©dito o d√©bito</span>
                                    <span class="badge gray">Hasta 3 cuotas sin inter√©s</span>
                                </div>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('mercadopago_card') |
                                    number:'1.2-2' }}</span>
                            </label>
                            <div class="payment-body" *ngIf="pagoForm.get('metodo')?.value === 'mercadopago_card'">
                                <p style="margin: 0;">Vas a ser redirigido a Mercado Pago para completar tu pago de
                                    forma segura.</p>
                            </div>
                        </div>

                        <!-- Transferencia -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="payment-radio-group">
                                    <input type="radio" formControlName="metodo" value="transferencia"
                                        (change)="updateDiscount()">
                                    <span class="payment-name">Transferencia</span>
                                    <span class="badge">Hasta 15% OFF</span>
                                </div>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('transferencia') |
                                    number:'1.2-2' }}</span>
                            </label>
                            <div class="payment-body" *ngIf="pagoForm.get('metodo')?.value === 'transferencia'">
                                <p>Pag√°s ${{ getFinalTotal() | number:'1.2-2' }}. <strong>¬°Ten√©s descuento por
                                        transferencia!</strong> (10% en Shorts, 15% en el resto). Cuando termines la
                                    compra, vas a ver la informaci√≥n de
                                    pago.</p>
                            </div>
                        </div>

                        <!-- Efectivo (Rapipago) -->
                        <div class="payment-item">
                            <label class="payment-header">
                                <div class="payment-radio-group">
                                    <input type="radio" formControlName="metodo" value="efectivo"
                                        (change)="updateDiscount()">
                                    <span class="payment-name">Efectivo (Pago F√°cil / Rapipago)</span>
                                    <span class="badge">Hasta 15% OFF</span>
                                </div>
                                <span class="price-info">Pag√°s ${{ getDiscountedHeaderPrice('efectivo') | number:'1.2-2'
                                    }}</span>
                            </label>
                            <div class="payment-body" *ngIf="pagoForm.get('metodo')?.value === 'efectivo'">
                                <p>Pag√°s ${{ getFinalTotal() | number:'1.2-2' }}. <strong>¬°Ten√©s descuento por
                                        efectivo!</strong> (10% en Shorts, 15% en el resto)</p>
                            </div>
                        </div>

                    </div>

                    <div class="actions">
                        <button class="btn-secondary" (click)="prevStep()">Volver</button>
                        <button class="btn-primary full-width" [disabled]="pagoForm.invalid || loading"
                            (click)="finalizarCompra()">
                            {{ loading ? 'Procesando...' : 'REALIZAR PEDIDO' }}
                        </button>
                    </div>
                </div>

                <!-- STEP 4: SUCCESS SCREEN (REDESIGNED) -->
                <div *ngSwitchCase="4" class="success-screen redesigned">
                    <!-- Success screen content is handled by dedicated page now, but keeping this as backup or removing if unused -->
                    <!-- We redirect to /pedido-exitoso, so this might not be seen. keeping as fallback. -->
                    <div class="success-two-col-layout">
                        <!-- ... existing content ... -->
                    </div>
                </div>

            </div>
        </div>

        <!-- SIDEBAR RESUMEN -->
        <div class="summary-sidebar" *ngIf="currentStep < 4">
            <!-- ... existing content ... -->
            <!-- Payment Method Discount -->
            <div class="summary-row" *ngIf="getDiscountAmount() > 0">
                <span>Descuento Pago</span>
                <span class="discount-val">-${{ getDiscountAmount() | number:'1.0-0' }}</span>
            </div>

            <div class="summary-divider"></div>

            <!-- Total Highlight with Discount -->
            <div class="summary-row promo-highlight"
                *ngIf="getDiscountAmount() > 0 || getSelectedShipping()?.descuento">
                <span class="promo-title">Total con Descuentos:</span>
                <span class="promo-value">${{ getFinalTotal() | number:'1.2-2' }}</span>
            </div>

            <!-- Standard Total Row (Struckthrough if discounted) -->
            <div class="summary-row total"
                [class.strikethrough]="getDiscountAmount() > 0 || getSelectedShipping()?.descuento" *ngIf="!loading">
                <span>{{ (getDiscountAmount() > 0 || getSelectedShipping()?.descuento) ? 'Total sin desc.' : 'Total'
                    }}</span>
                <span>${{ (total + (getSelectedShipping()?.costo || 0)) | number:'1.2-2' }}</span>
            </div>

            <!-- Loading Indicator -->
            <div class="summary-row total" *ngIf="loading">
                <span>Total</span>
                <span>Calculando...</span>
            </div>

            <!-- Payment Promo Badge -->
            <div class="payment-method-promo" *ngIf="getDiscountAmount() > 0">
                ‚úì Descuento por pago con {{ pagoForm.get('metodo')?.value === 'transferencia' ? 'Transferencia' :
                'Efectivo' }} aplicado
            </div>

            <!-- Coupon Section -->
            <div class="coupon-section" [formGroup]="couponForm">
                <div class="coupon-input-group">
                    <input type="text" formControlName="code" placeholder="C√≥digo de cup√≥n">
                    <button class="btn-coupon" (click)="validateCoupon()"
                        [disabled]="couponForm.invalid || validatingCoupon">
                        {{ validatingCoupon ? '...' : 'Aplicar' }}
                    </button>
                </div>
                <p class="error-msg" *ngIf="couponError">{{ couponError }}</p>
                <p class="success-msg" *ngIf="couponSuccess">{{ couponSuccess }}</p>

                <div class="applied-coupon" *ngIf="appliedCoupon">
                    <div class="coupon-info">
                        <strong>üè∑Ô∏è {{ appliedCoupon.codigo }}</strong>
                        <span *ngIf="appliedCoupon.envio_gratis">Env√≠o Gratis</span>
                        <span
                            *ngIf="!appliedCoupon.envio_gratis && appliedCoupon.tipo_promocion_nombre === 'descuento_porcentaje'">
                            {{ appliedCoupon.valor }}% OFF
                        </span>
                        <span
                            *ngIf="!appliedCoupon.envio_gratis && appliedCoupon.tipo_promocion_nombre === 'descuento_fijo'">
                            ${{ appliedCoupon.valor }} OFF
                        </span>
                    </div>
                    <button class="remove-coupon" (click)="appliedCoupon = null; couponSuccess = ''">‚úï</button>
                </div>
                <!-- Version Marker -->
                <div class="version-marker" style="font-size: 10px; color: #ccc; text-align: right; margin-top: 10px;">
                    v1.2 - Refined Messages & Flows
                </div>
            </div>
        </div>
    </div>
</div>
</div>