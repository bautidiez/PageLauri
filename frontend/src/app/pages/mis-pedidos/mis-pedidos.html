<div class="account-container">
    <h1>Mi Cuenta</h1>
    <!-- DEBUG SECTION -->
    <div class="debug-panel"
        style="border: 2px solid #ff4444; background: #fff0f0; padding: 15px; margin-bottom: 20px; border-radius: 8px;">
        <h3 style="color: #d32f2f; margin-top: 0;">üõ† Panel de Diagn√≥stico (Si no ves tus pedidos)</h3>
        <p style="font-size: 14px; color: #333;"><strong>Tu usuario (seg√∫n el sistema):</strong> {{
            debugInfo.cliente?.email }}</p>
        <p style="font-size: 14px; color: #333;"><strong>Tu tel√©fono:</strong> {{ debugInfo.cliente?.telefono }}</p>
        <p style="font-size: 14px; color: #333;"><strong>Estado Token:</strong> {{ debugInfo.token }}</p>
        <div *ngIf="debugError" style="margin-top: 10px; color: #d32f2f;">
            <strong>ERROR DETECTADO:</strong>
            <pre style="background: #ffebee; padding: 10px; overflow: auto;">{{ debugError }}</pre>
        </div>
        <div *ngIf="debugResponse" style="margin-top: 10px;">
            <strong>Respuesta del Servidor (Pedidos encontrados: {{debugResponse?.length}}):</strong>
            <pre
                style="background: #eee; padding: 10px; max-height: 100px; overflow: auto; font-size: 12px;">{{ debugResponse | json }}</pre>
        </div>
        <p style="font-size: 12px; color: #666; margin-top: 5px;">Por favor, enviame una captura de esta pantalla si el
            problema persiste.</p>
    </div>

    <p style="text-align: center; color: #666; margin-bottom: 30px;">
        Usuario: {{ currentUserEmail }}
    </p>

    <div class="account-grid">
        <!-- LEFT COLUMN: MIS DATOS -->
        <div class="account-section">
            <div class="section-header">
                <span>Mis datos</span>
                <a class="edit-link" *ngIf="!isEditingProfile" (click)="toggleEditMode()">Editar ></a>
            </div>
            <div class="section-content">
                <!-- VIEW MODE -->
                <div *ngIf="!isEditingProfile">
                    <div class="data-row">
                        <span class="data-icon">üë§</span>
                        <span>{{ profileData.nombre }}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-icon">‚úâÔ∏è</span>
                        <span>{{ profileData.email }}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-icon">üìû</span>
                        <span>{{ profileData.telefono || 'Sin tel√©fono' }}</span>
                    </div>

                    <!-- Security Section (Only in View Mode) -->
                    <div class="security-section">
                        <button class="security-link-btn" (click)="togglePasswordModal()">
                            Cambiar contrase√±a >
                        </button>
                    </div>
                </div>

                <!-- EDIT MODE -->
                <div class="edit-form" *ngIf="isEditingProfile">
                    <div class="form-group">
                        <label>Nombre Completo</label>
                        <input type="text" [(ngModel)]="profileData.nombre" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono</label>
                        <input type="tel" [(ngModel)]="profileData.telefono" class="form-control">
                    </div>
                    <div class="btn-group">
                        <button class="btn-save" (click)="saveProfile()" [disabled]="savingProfile">
                            {{ savingProfile ? 'Guardando...' : 'Guardar cambios' }}
                        </button>
                        <button class="btn-cancel" (click)="toggleEditMode()">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: MIS COMPRAS -->
        <div class="account-section">
            <div class="section-header">
                <span>Mis compras</span>
            </div>
            <div class="section-content">
                <div class="no-orders-container" *ngIf="!loadingOrders && pedidos.length === 0">
                    <p class="no-orders-text">¬°Hac√© tu primera compra!</p>
                    <a routerLink="/productos" class="shop-now-link">Ir a la tienda ></a>
                </div>

                <div class="loading-spinner" *ngIf="loadingOrders">
                    Cargando pedidos...
                </div>

                <div class="pedidos-list" *ngIf="!loadingOrders && pedidos.length > 0">
                    <div class="pedido-card" *ngFor="let p of pedidos" (click)="verDetalle(p)">
                        <div class="card-header">
                            <span class="order-date">{{ p.created_at | date:'dd/MM/yyyy' }}</span>
                        </div>
                        <div class="card-body">
                            <div class="status-badge" [ngStyle]="{'background-color': getEstadoColor(p)}">
                                {{ getEstadoLabel(p) | uppercase }}
                            </div>
                            <div class="order-total">
                                <strong>${{ p.total | number:'1.0-2' }}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CHANGE PASSWORD -->
    <div class="modal-overlay" *ngIf="showPasswordModal" (click)="togglePasswordModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <button class="btn-close" (click)="togglePasswordModal()">‚úï</button>
            <h2>Cambiar Contrase√±a</h2>

            <div class="form-group">
                <label>Contrase√±a Actual</label>
                <input type="password" [(ngModel)]="passwordData.old" class="form-control">
            </div>
            <div class="form-group">
                <label>Nueva Contrase√±a</label>
                <input type="password" [(ngModel)]="passwordData.new" class="form-control">
            </div>
            <div class="form-group">
                <label>Confirmar Nueva Contrase√±a</label>
                <input type="password" [(ngModel)]="passwordData.confirm" class="form-control">
            </div>

            <button class="btn-primary" (click)="changePassword()" [disabled]="changingPassword">
                {{ changingPassword ? 'Actualizando...' : 'Cambiar Contrase√±a' }}
            </button>

            <div class="forgot-link">
                <a routerLink="/recuperar-password" (click)="togglePasswordModal()">o olvid√© mi contrase√±a actual</a>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLE PEDIDO -->
    <div class="modal-overlay" *ngIf="pedidoDetalle" (click)="cerrarDetalle()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <button class="btn-close" (click)="cerrarDetalle()">‚úï</button>
            <h2>Detalle del Pedido #{{ pedidoDetalle.numero_pedido }}</h2>

            <div class="status-banner" [ngStyle]="{'background-color': getEstadoColor(pedidoDetalle)}">
                {{ getEstadoLabel(pedidoDetalle) | uppercase }}
            </div>

            <div class="info-section">
                <h3>Informaci√≥n de entrega</h3>
                <p>{{ pedidoDetalle.cliente_nombre }}</p>
                <p>{{ pedidoDetalle.cliente_direccion }}</p>
                <p>{{ pedidoDetalle.cliente_localidad }}, {{ pedidoDetalle.cliente_provincia }}</p>
            </div>

            <div class="info-section" *ngIf="pedidoDetalle.envio">
                <h3>Seguimiento</h3>
                <p><strong>Transportista:</strong> {{ pedidoDetalle.envio.transportista }}</p>
                <div *ngIf="pedidoDetalle.envio.numero_guia">
                    <p><strong>Gu√≠a:</strong> {{ pedidoDetalle.envio.numero_guia }}</p>
                    <a *ngIf="getTrackingUrl(pedidoDetalle.envio.transportista, pedidoDetalle.envio.numero_guia) as url"
                        [href]="url" target="_blank" class="btn-track">
                        Ver Seguimiento en {{ pedidoDetalle.envio.transportista }}
                    </a>
                </div>
            </div>

            <div class="info-section">
                <h3>Productos</h3>
                <div class="items-mini">
                    <div class="item-mini" *ngFor="let item of pedidoDetalle.items">
                        {{ item.cantidad }}x {{ item.producto_nombre }} ({{ item.talle_nombre }})
                        <span>${{ item.subtotal | number:'1.0-0' }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>