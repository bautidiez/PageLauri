<header class="header">
  <div class="header-top">
    <div class="container">
      <div class="header-top-content">
        <div class="header-links-custom">
          <ng-container *ngIf="!isAdmin && !isCliente">
            <a routerLink="/login" class="header-link">Iniciar sesi√≥n</a>
            <a routerLink="/registro" class="header-link">Crear cuenta</a>
          </ng-container>
          <ng-container *ngIf="isAdmin || isCliente">
            <span class="user-welcome" *ngIf="currentUser">Hola, {{ currentUser.username || currentUser.nombre }}</span>
            <a routerLink="/mis-pedidos" class="header-link">Mi Cuenta</a>
            <a *ngIf="isAdmin" routerLink="/admin" class="header-link">Panel Admin</a>
            <a (click)="logout()" class="header-link" style="cursor: pointer;">Cerrar sesi√≥n</a>
          </ng-container>
        </div>
        <div class="header-contact-custom">
          <a routerLink="/contacto" class="header-link">Contacto</a>
        </div>
      </div>
    </div>
  </div>

  <div class="header-main">
    <div class="container-full">
      <div class="header-content-single-line">
        <!-- Logo -->
        <div class="logo">
          <a routerLink="/">
            <img src="/assets/logo.png" alt="elvestuario" class="logo-img"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <h1 class="logo-text" style="display: none;">EL VESTUARIO</h1>
          </a>
        </div>

        <!-- Men√∫ de navegaci√≥n -->
        <nav class="nav-desktop">
          <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}">Inicio</a>

          <!-- Contenedor del men√∫ de Productos -->
          <div class="nav-dropdown">
            <a routerLink="/productos" routerLinkActive="active" class="nav-link" (mouseenter)="openProductsMenu()"
              (mouseleave)="scheduleCloseProductsMenu()">
              Productos <span>‚ñº</span>
            </a>

            <!-- MEGA MENU -->
            <div class="mega-menu" [class.show]="isProductsMenuOpen" (mouseenter)="cancelCloseProductsMenu()"
              (mouseleave)="closeProductsMenuNow()">
              <div class="mega-menu-content">
                <!-- Columna 1: Categor√≠as Principales -->
                <div class="mega-column main-cats">
                  <div class="mega-item total-link">
                    <a routerLink="/productos" class="full-link" (click)="closeProductsMenuNow()">Ver todos los
                      productos</a>
                  </div>

                  <div class="mega-item offers-link">
                    <a routerLink="/productos" [queryParams]="{ofertas: 'true'}" class="full-link"
                      (click)="closeProductsMenuNow()">üî• OFERTAS</a>
                  </div>

                  <hr class="mega-divider">

                  <!-- Categor√≠as -->
                  <div *ngFor="let cat of categoriasTree" class="mega-item hierarchical-item"
                    [class.active]="activeCategory?.id === cat.id" (mouseenter)="setActiveCategory(cat)">

                    <!-- Enlace directo a la categor√≠a -->
                    <a [routerLink]="['/categoria', cat.slug || cat.id]" (click)="closeProductsMenuNow()"
                      class="cat-link-text">
                      {{ cat.nombre }}
                    </a>

                    <!-- Indicador de submen√∫ (Solo visual o hover) -->
                    <span class="arrow" *ngIf="cat.subcategorias && cat.subcategorias.length > 0">‚Ä∫</span>
                  </div>
                </div>

                <!-- Columna 2: Subcategor√≠as (Din√°mica) -->
                <div class="mega-column sub-cats" *ngIf="activeCategory?.subcategorias?.length > 0">
                  <div *ngFor="let sub of activeCategory.subcategorias" class="mega-item sub-item">
                    <a [routerLink]="['/categoria', activeCategory.slug || activeCategory.id, sub.slug || sub.id]"
                      (click)="closeProductsMenuNow()" class="cat-link-text">
                      {{ sub.nombre }}
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <a routerLink="/contacto" routerLinkActive="active">Contacto</a>
          <a routerLink="/encargo-especial" routerLinkActive="active">Encargo personalizado</a>
          <a routerLink="/politica-cambio" routerLinkActive="active">Pol√≠tica de cambio</a>
          <a routerLink="/guia-talles" routerLinkActive="active">Gu√≠a de talles</a>
        </nav>

        <!-- Buscador estilo imagen -->
        <div class="search-box-simple">
          <span class="search-icon-left"></span>
          <input type="text" class="search-input-simple" placeholder="Buscar" [ngModel]="busqueda"
            (ngModelChange)="onSearchInput($event)" (keyup.enter)="buscarProductos()" (focus)="onSearchFocus()"
            (blur)="onSearchBlur()">

          <!-- Dropdown de resultados predictivos -->
          <div class="search-results-dropdown"
            *ngIf="showSearchResults && (isSearching || searchResults.length > 0 || busqueda)">
            <div class="search-loading" *ngIf="isSearching">Buscando...</div>

            <ng-container *ngIf="!isSearching">
              <div *ngIf="searchResults.length === 0" class="no-results">
                No se encontraron productos.
              </div>

              <div *ngFor="let producto of searchResults" class="search-result-item"
                (click)="selectSearchResult(producto)">
                <img [src]="apiService.getFormattedImageUrl(producto.imagenes?.[0]?.url)" alt="Img" class="result-img">
                <div class="result-info">
                  <span class="result-name">{{ producto.nombre }}</span>
                  <div class="result-prices">
                    <span class="result-price" [class.discounted]="producto.precio_descuento > 0">${{
                      (producto.precio_descuento || producto.precio_base) | currency:'ARS':'symbol-narrow':'1.0-0'
                      }}</span>
                    <span class="result-original-price" *ngIf="producto.precio_descuento > 0">${{ producto.precio_base |
                      currency:'ARS':'symbol-narrow':'1.0-0' }}</span>
                  </div>
                </div>
              </div>

              <div *ngIf="searchResults.length > 0" class="view-all-results" (click)="buscarProductos()">
                Ver todos los resultados
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Carrito con Badge -->
        <button class="cart-btn-simple" (click)="goToCart()">
          <span class="cart-icon"></span>
          <span class="cart-total">{{ (cartTotal$ | async | currency:'ARS':'symbol-narrow':'1.2-2') || '$0' }}</span>

          <!-- BADGE de cantidad en esquina superior derecha -->
          <span class="cart-badge-count" *ngIf="cartItemCount > 0">{{ cartItemCount }}</span>
        </button>

        <!-- Toggle m√≥vil -->
        <button class="menu-toggle" (click)="toggleMenu()">
          <span *ngIf="!menuOpen">‚ò∞</span>
          <span *ngIf="menuOpen">‚úï</span>
        </button>
      </div>
    </div>
  </div>

  <nav class="nav-mobile" [class.open]="menuOpen">
    <a routerLink="/" routerLinkActive="active" [routerLinkActiveOptions]="{exact: true}"
      (click)="menuOpen = false">Inicio</a>
    <a routerLink="/productos" routerLinkActive="active" (click)="menuOpen = false">Productos</a>
    <a routerLink="/productos" [queryParams]="{ofertas: 'true'}" (click)="menuOpen = false">üî• OFERTAS</a>

    <!-- Categor√≠as din√°micas -->
    <ng-container *ngFor="let cat of categoriasTree">
      <a [routerLink]="['/categoria', cat.slug || cat.id]" (click)="menuOpen = false; $event.stopPropagation()">
        {{ cat.nombre }}
      </a>
      <!-- Subcategor√≠as (si existen) -->
      <a *ngFor="let sub of cat.subcategorias" [routerLink]="['/categoria', cat.slug || cat.id, sub.slug || sub.id]"
        (click)="menuOpen = false; $event.stopPropagation()" class="subcategoria-mobile">
        &nbsp;&nbsp;‚Ä∫ {{ sub.nombre }}
      </a>
    </ng-container>

    <a routerLink="/contacto" routerLinkActive="active" (click)="menuOpen = false">Contacto</a>
    <a routerLink="/encargo-especial" routerLinkActive="active" (click)="menuOpen = false">Encargo personalizado</a>
    <a routerLink="/politica-cambio" routerLinkActive="active" (click)="menuOpen = false">Pol√≠tica de cambio</a>
    <a routerLink="/guia-talles" routerLinkActive="active" (click)="menuOpen = false">Gu√≠a de talles</a>
    <a *ngIf="isCliente || isAdmin" routerLink="/mis-pedidos" (click)="menuOpen = false">Mi Cuenta</a>
    <a *ngIf="isAdmin" routerLink="/admin" (click)="menuOpen = false">Panel Admin</a>
    <a *ngIf="isAdmin || isCliente" (click)="logout(); menuOpen = false">Cerrar sesi√≥n</a>
  </nav>
</header>