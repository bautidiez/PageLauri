<div class="shipping-calculator">
    <div class="calculator-header">
        <img src="/assets/envio.png" alt="Env√≠o" class="shipping-icon">
        <h3 class="calculator-title">Medios de env√≠o</h3>
    </div>

    <div class="calculator-body">
        <!-- Modo inicial: ingresar CP -->
        <div *ngIf="!mostrarResultados || editandoCodigoPostal" class="input-group">
            <input type="text" [(ngModel)]="codigoPostal" placeholder="Tu c√≥digo postal" class="cp-input"
                (keyup.enter)="calcular()">
            <button class="calc-button" (click)="calcular()" [disabled]="calculando">
                <span>{{ calculando ? 'CALCULANDO...' : 'CALCULAR' }}</span>
            </button>
        </div>

        <a href="https://www.correoargentino.com.ar/formularios/cpa" target="_blank" class="cp-link"
            *ngIf="!mostrarResultados || editandoCodigoPostal">
            No s√© mi c√≥digo postal
        </a>

        <div class="error-msg" *ngIf="error">
            {{ error }}
        </div>
    </div>

    <!-- Resultados: mostrar opciones agrupadas -->
    <div class="calculator-results" *ngIf="mostrarResultados && !editandoCodigoPostal">
        <div class="results-header">
            <h4>Entregas para el CP: {{ codigoPostalCalculado }}</h4>
            <button class="change-cp-btn" (click)="cambiarCodigoPostal()">Cambiar c√≥digo postal</button>
        </div>

        <!-- Env√≠o a domicilio -->
        <div class="shipping-section" *ngIf="getOpcionesDomicilio().length > 0">
            <h5 class="section-title">üì¶ Env√≠o a domicilio</h5>
            <div class="shipping-options">
                <div class="shipping-item" *ngFor="let opcion of getOpcionesDomicilio(); let i = index"
                    [class.hidden]="!mostrarTodasOpciones && i >= 5">
                    <div class="item-main">
                        <span class="metodo-nombre">{{ opcion.nombre }}</span>
                        <span class="metodo-tiempo">{{ opcion.tiempo }}</span>
                    </div>
                    <div class="item-price">
                        <span class="price-val">${{ opcion.costo | number:'1.0-0' }}</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Retirar por -->
        <div class="shipping-section" *ngIf="getOpcionesRetiro().length > 0">
            <h5 class="section-title">üè™ Retirar por</h5>
            <div class="shipping-options">
                <div class="shipping-item" *ngFor="let opcion of getOpcionesRetiro()">
                    <div class="item-main">
                        <span class="metodo-nombre">{{ opcion.nombre }}</span>
                        <span class="metodo-tiempo">{{ opcion.tiempo }}</span>
                        <a *ngIf="opcion.nombre.toLowerCase().includes('correo') && !opcion.nombre.toLowerCase().includes('local')"
                            href="javascript:void(0)" class="ver-direcciones-link"
                            (click)="verPuntosRetiro('correo_argentino')">üìç Ver direcciones</a>
                        <a *ngIf="opcion.nombre.toLowerCase().includes('andreani') && !opcion.nombre.toLowerCase().includes('local')"
                            href="javascript:void(0)" class="ver-direcciones-link"
                            (click)="verPuntosRetiro('andreani')">üìç Ver direcciones</a>
                    </div>
                    <div class="item-price">
                        <span class="price-val" *ngIf="opcion.costo > 0">${{ opcion.costo | number:'1.0-0' }}</span>
                        <span class="price-val free" *ngIf="opcion.costo === 0">Gratis</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toggle para ver m√°s/menos opciones -->
        <button class="toggle-options-btn" (click)="toggleOpciones()" *ngIf="getOpcionesDomicilio().length > 5">
            {{ mostrarTodasOpciones ? 'Ver menos opciones de env√≠o' : 'Ver m√°s opciones de env√≠o' }}
        </button>

        <div class="total-updated" *ngIf="precioBase > 0">
            <div class="total-row main-total">
                <span>Total con env√≠o:</span>
                <span class="total-val">${{ (precioBase + opcionesEnvio[0]?.costo || 0) | number:'1.0-0' }}</span>
            </div>
            <div class="total-row promo-total">
                <span class="promo-label">Precio con transferencia:</span>
                <span class="promo-val">${{ getPrecioConTransferencia(opcionesEnvio[0]?.costo || 0) | number:'1.2-2'
                    }}</span>
                <span class="promo-badge">¬°15% OFF!</span>
            </div>
        </div>
    </div>

    <!-- Modal de puntos de retiro -->
    <app-pickup-points-modal [visible]="mostrarModalPuntos" [puntos]="puntosRetiro"
        [codigoPostal]="codigoPostalCalculado" [carrier]="carrierSeleccionado" (close)="cerrarModalPuntos()"
        (selectPoint)="seleccionarPunto($event)">
    </app-pickup-points-modal>
</div>